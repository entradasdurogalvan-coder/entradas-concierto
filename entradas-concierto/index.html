<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entradas Concierto Duro Galv√°n- Reserva Online</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f0f2f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .counter { background: #e3f2fd; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        button { background: #2196F3; color: white; border: none; padding: 15px; border-radius: 5px; cursor: pointer; width: 100%; font-size: 16px; margin: 10px 0; }
        button:hover { background: #1976D2; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .bizum-info { background: #e8f5e8; padding: 20px; border-radius: 8px; margin: 20px 0; text-align: center; }
        .qr-container { text-align: center; margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; }
        .hidden { display: none; }
        .status-pending { background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .status-active { background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #2196F3; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéµ Concierto Duro Galv√°n</h1>
            <p>Reserva tu entrada ahora - Pago por Bizum</p>
        </div>
        
        <!-- PASO 1: Formulario de Reserva -->
        <div id="step1" class="step active">
            <div class="counter">
                <h3>ENTRADAS DISPONIBLES</h3>
                <div id="availableTickets" style="font-size: 2.5em; font-weight: bold; color: #2196F3;">100</div>
                <p>Total: 100 entradas</p>
            </div>
            
            <form id="reservationForm">
                <div class="form-group">
                    <label for="name">Nombre completo *</label>
                    <input type="text" id="name" required placeholder="Tu nombre completo">
                </div>
                
                <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" id="email" required placeholder="tu@email.com">
                </div>
                
                <div class="form-group">
                    <label for="phone">Tel√©fono *</label>
                    <input type="tel" id="phone" required placeholder="+34 612 345 678">
                </div>
                
                <div class="form-group">
                    <label for="ticketType">Tipo de entrada</label>
                    <select id="ticketType">
                        <option value="general">Entrada General - 10‚Ç¨</option>
                    </select>
                </div>
                
                <button type="submit" id="reserveBtn">Reservar Entrada</button>
            </form>
        </div>
        
        <!-- PASO 2: Instrucciones Bizum -->
        <div id="step2" class="step">
            <div class="loading" id="creatingReservation">
                <div class="loading-spinner"></div>
                <p>Creando tu reserva...</p>
            </div>
            
            <div id="bizumInstructions" class="hidden">
                <h2>‚úÖ Reserva Creada Exitosamente</h2>
                <p>Tu c√≥digo de reserva: <strong id="reservationCode" style="font-size: 1.2em;"></strong></p>
                
                <div class="bizum-info">
                    <h3>Realiza el pago por Bizum</h3>
                    <div style="font-size: 2em; font-weight: bold; color: #2196F3;" id="bizumAmount">25‚Ç¨</div>
                    <p>Al n√∫mero de tel√©fono:</p>
                    <div style="font-size: 1.5em; font-weight: bold; color: #1976D2;" id="bizumNumber">+34 612 345 678</div>
                    <p>Concepto: <strong id="bizumConcept" style="font-size: 1.1em;"></strong></p>
                </div>
                
                <div class="status-pending">
                    ‚è≥ Estado: Pendiente de pago
                </div>
                
                <p><strong>üìß Se ha enviado un email a tu correo con estas instrucciones</strong></p>
                
                <p><strong>Instrucciones importantes:</strong></p>
                <ol style="text-align: left;">
                    <li>Realiza el pago por Bizum en los pr√≥ximos 15 minutos</li>
                    <li>Usa el concepto EXACTO que se muestra arriba</li>
                    <li>Recibir√°s otro email cuando active tu entrada</li>
                    <li>Puedes verificar el estado cuando quieras</li>
                </ol>
                
                <button onclick="checkPaymentStatus()">üîç Verificar Estado del Pago</button>
                <button onclick="showStep(1)" style="background: #6c757d;">‚Üê Volver atr√°s</button>
            </div>
        </div>
        
        <!-- PASO 3: Entrada Confirmada -->
        <div id="step3" class="step">
            <h2>üéâ ¬°Entrada Confirmada!</h2>
            <p>Tu pago ha sido verificado y tu entrada est√° activa.</p>
            
            <div class="status-active">
                ‚úÖ Estado: Entrada activa
            </div>
            
            <div class="qr-container">
                <h3>Tu c√≥digo QR de entrada</h3>
                <canvas id="qrCode"></canvas>
                <p>Muestra este c√≥digo QR en la entrada del evento</p>
                <p><strong>üìß Se ha enviado un email con esta informaci√≥n a tu correo</strong></p>
            </div>
            
            <button onclick="saveTicket()">üì• Guardar Entrada como Imagen</button>
            <button onclick="window.print()" style="background: #6c757d;">üñ®Ô∏è Imprimir Entrada</button>
            <button onclick="showStep(1)" style="background: #28a745;">‚ûï Hacer otra reserva</button>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN - ¬°CAMBIAR ESTOS DATOS!
        const CONFIG = {
            MAX_TICKETS: 100,
            BIZUM_NUMBER: '+34 646 98 52 89',  // ‚Üê TU N√öMERO DE BIZUM
            TICKET_PRICES: {
                general: 10
            },
            EMAILJS: {
                PUBLIC_KEY: 'GfdkisBU7SIwEIk0d',        // ‚Üê TU PUBLIC KEY de EmailJS
                SERVICE_ID: 'service_iwvax43',        // ‚Üê TU SERVICE ID de EmailJS
                TEMPLATE_CONFIRMATION: 'template_ha4c27w', // ‚Üê Template ID confirmaci√≥n
                TEMPLATE_ACTIVE: 'template_k2wp5jl' // ‚Üê Template ID entrada activa
            }
        };

        let currentReservation = null;

        // Cuando la p√°gina carga
        document.addEventListener('DOMContentLoaded', function() {
            loadTicketCount();
            initializeEmailJS();
            
            document.getElementById('reservationForm').addEventListener('submit', function(e) {
                e.preventDefault();
                createReservation();
            });
        });

        // Inicializar EmailJS
        function initializeEmailJS() {
            emailjs.init(CONFIG.EMAILJS.PUBLIC_KEY);
            console.log("‚úÖ EmailJS inicializado correctamente");
        }

        // Cargar contador de entradas disponibles
        async function loadTicketCount() {
            try {
                const response = await fetch('/.netlify/functions/ticket-count');
                const data = await response.json();
                document.getElementById('availableTickets').textContent = data.available;
                
                if (data.available <= 0) {
                    disableReservations();
                }
            } catch (error) {
                console.log('Error cargando contador:', error);
            }
        }

        function disableReservations() {
            const btn = document.getElementById('reserveBtn');
            btn.disabled = true;
            btn.textContent = 'ENTRADAS AGOTADAS';
            btn.style.background = '#dc3545';
        }

        // Crear nueva reserva
        async function createReservation() {
            const formData = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                ticketType: document.getElementById('ticketType').value,
                price: CONFIG.TICKET_PRICES[document.getElementById('ticketType').value]
            };

            try {
                showStep(2);
                
                const response = await fetch('/.netlify/functions/create-reservation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (result.success) {
                    currentReservation = result.reservation;
                    document.getElementById('creatingReservation').classList.add('hidden');
                    document.getElementById('bizumInstructions').classList.remove('hidden');
                    showBizumInstructions(result.reservation);
                    
                    // ‚úÖ ENVIAR EMAIL DE CONFIRMACI√ìN
                    await sendConfirmationEmail(formData, result.reservation);
                    
                } else {
                    alert('Error: ' + result.error);
                    showStep(1);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al crear la reserva. Int√©ntalo de nuevo.');
                showStep(1);
            }
        }

        // Funci√≥n para enviar email de confirmaci√≥n
        async function sendConfirmationEmail(formData, reservation) {
            try {
                const templateParams = {
                    name: formData.name,
                    reservation_id: reservation.id,
                    amount: reservation.amount + '‚Ç¨',
                    bizum_number: CONFIG.BIZUM_NUMBER
                };

                const result = await emailjs.send(
                    CONFIG.EMAILJS.SERVICE_ID,
                    CONFIG.EMAILJS.TEMPLATE_CONFIRMATION,
                    templateParams
                );
                
                console.log('‚úÖ Email de confirmaci√≥n enviado a:', formData.email);
                return result;
            } catch (error) {
                console.error('‚ùå Error enviando email de confirmaci√≥n:', error);
                // No mostramos alerta para no interrumpir la experiencia del usuario
                return null;
            }
        }

        // Funci√≥n para enviar email de entrada activa
        async function sendTicketEmail(reservation) {
            try {
                const templateParams = {
                    name: reservation.name,
                    reservation_id: reservation.id,
                    ticket_type: reservation.ticketType.toUpperCase(),
                    ticket_url: window.location.href
                };

                const result = await emailjs.send(
                    CONFIG.EMAILJS.SERVICE_ID,
                    CONFIG.EMAILJS.TEMPLATE_ACTIVE,
                    templateParams
                );
                
                console.log('‚úÖ Email de entrada activa enviado a:', reservation.email);
                return result;
            } catch (error) {
                console.error('‚ùå Error enviando email de entrada activa:', error);
                return null;
            }
        }

        // Mostrar instrucciones de pago Bizum
        function showBizumInstructions(reservation) {
            document.getElementById('reservationCode').textContent = reservation.id;
            document.getElementById('bizumAmount').textContent = reservation.amount + '‚Ç¨';
            document.getElementById('bizumConcept').textContent = reservation.id;
            document.getElementById('bizumNumber').textContent = CONFIG.BIZUM_NUMBER;
        }

        // Verificar si el pago fue confirmado
        async function checkPaymentStatus() {
            if (!currentReservation) return;
            
            try {
                const response = await fetch('/.netlify/functions/check-reservation?id=' + currentReservation.id);
                const result = await response.json();
                
                if (result.reservation && result.reservation.status === 'active') {
                    generateQRCode(currentReservation);
                    showStep(3);
                    
                    // ‚úÖ ENVIAR EMAIL DE ENTRADA ACTIVA
                    await sendTicketEmail(currentReservation);
                    
                } else {
                    alert('El pago a√∫n no ha sido verificado. Revisaremos tu Bizum manualmente y te avisaremos por email cuando active tu entrada.');
                }
            } catch (error) {
                alert('Error al verificar el estado. Int√©ntalo m√°s tarde.');
            }
        }

        // Generar c√≥digo QR
        function generateQRCode(reservation) {
            const qrData = JSON.stringify({
                id: reservation.id,
                name: reservation.name,
                event: "Concierto Exclusivo",
                type: reservation.ticketType,
                valid: true,
                timestamp: new Date().getTime()
            });

            QRCode.toCanvas(document.getElementById('qrCode'), qrData, {
                width: 200,
                margin: 2,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                }
            }, function(error) {
                if (error) {
                    console.error('Error generando QR:', error);
                    alert('Error creando el c√≥digo QR');
                }
            });
        }

        // Guardar entrada como imagen
        function saveTicket() {
            const canvas = document.getElementById('qrCode');
            const link = document.createElement('a');
            link.download = 'entrada-' + currentReservation.id + '.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        // Cambiar entre pasos
        function showStep(stepNumber) {
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById('step' + stepNumber).classList.add('active');
            
            // Scroll to top
            window.scrollTo(0, 0);
        }
    </script>
</body>
</html>
